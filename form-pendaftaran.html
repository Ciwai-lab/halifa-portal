<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Pendaftaran ‚Äî PKBM HALIFA</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="style.css" rel="stylesheet"> <!-- ini harus terakhir -->

  <link rel="icon" type="image/webp" href="/assets/images/favicon.webp" />
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      margin: 0;
      background: #f3f4f6;
    }

    .container {
      max-width: 980px;
      margin: auto;
      padding: 16px;
    }

    h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #1f2937;
    }

    .section-title {
      margin-top: 2.5rem;
      /* jarak dari atas */
      margin-bottom: 1.5rem;
      /* jarak ke bawah */
      font-size: 1.5rem;
      /* agak besar */
      font-weight: 700;
      /* bold */
      color: #1e293b;
      /* abu gelap elegan */
      position: relative;
      /* biar bisa pasang garis */
      padding-bottom: 0.5rem;
      /* kasih ruang buat garis */
    }

    .section-title::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: 0;
      width: 60px;
      /* panjang garis */
      height: 3px;
      /* tebal garis */
      background: linear-gradient(to right, #2563eb, #38bdf8);
      border-radius: 2px;
    }

    /* === Tabs === */
    .tabs {
      display: flex;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 16px;
      overflow-x: auto;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-bottom: none;
      font-size: 14px;
      transition: 0.2s;
    }

    .tab.active {
      background: #fff;
      font-weight: 600;
      color: #2563eb;
      border-top: 3px solid #2563eb;
    }

    .tab-content {
      display: none;
      background: #fff;
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
    }

    .tab-content.active {
      display: block;
    }

    /* === Form elements === */
    label {
      display: block;
      margin-top: 10px;
      font-size: 14px;
      color: #374151;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    button {
      margin-top: 12px;
      /* Jarak atas tombol */
      padding: 10px 16px;
      /* Padding lebih proporsional */
      border: none;
      /* Hapus border default */
      border-radius: 8px;
      /* Sudut membulat */
      background-color: #2563eb;
      /* Warna utama */
      color: #fff;
      /* Warna teks putih */
      font-size: 14px;
      /* Ukuran teks */
      font-weight: 500;
      /* Sedikit bold untuk keterbacaan */
      cursor: pointer;
      /* Pointer saat hover */
      transition: all 0.2s ease-in-out;
      /* Animasi smooth untuk hover */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      /* Shadow ringan */
    }

    button:hover {
      background-color: #1d4ed8;
      /* Warna hover */
      transform: translateY(-1px);
      /* Sedikit naik saat hover */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }


    .btn-ghost {
      background: #6b7280;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }

    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f9fafb;
    }

    .preview-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      background: #f9fafb;
    }

    .small {
      font-size: 12px;
      color: #6b7280;
    }

    @media (max-width: 767px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .grid>[style*="grid-column"] {
        grid-column: auto ! important;
      }

      input,
      select,
      textarea {
        font-size: 15px;
        padding: 10px;
      }

      button {
        width: 100%;
        /* tombol full width biar gampang diklik */
        margin-top: 8px;
      }

      .tab {
        font-size: 13px;
        padding: 10px;
      }
    }

    html {
      scroll-behavior: smooth;
    }

    .preview-card {
      border: 1px solid #e5e7eb;
      /* gray-200 */
      border-radius: 8px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .preview-card p {
      margin: 4px 0;
      font-size: 14px;
    }

    .preview-card button {
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 6px;
    }

    .card-total {
      border-left: 4px solid #353332;
      /* oranye terang sebagai accent */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card-total:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .card {
      background: #ffffff;
      /* putih bersih */
      border-radius: 1rem;
      /* sudut bulat */
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      /* shadow lembut */
      transition: transform 0.2s, box-shadow 0.2s;
    }

    /* Hover effect: card ‚Äúangkat‚Äù */
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    /* Optional accent per type */
    .card-gender {
      border-left: 4px solid #42a5f5;
    }

    /* biru untuk gender laki-laki */
    .card-rombel {
      border-left: 4px solid #66bb6a;
    }

    /* hijau untuk rombel */
    .card-other {
      border-left: 4px solid #ffa726;
    }

    /* oranye untuk Lainnya */
  </style>
</head>

<body>
  <div class="container text-center my-8">
    <h2 class="text-3xl font-bold tracking-wide relative inline-block pb-2">
      Sistem Pendaftaran ‚Äî PKBM HALIFA
      <span class="absolute left-1/2 -bottom-1 w-16 h-1 bg-blue-500 rounded -translate-x-1/2"></span>
    </h2>
  </div>

  <!-- Tabs -->
  <div class="tabs flex flex-wrap justify-center gap-2 mt-4 border-b pb-2">
    <div class="tab active" data-tab="tab1">üìù Form</div>
    <div class="tab" data-tab="tab2">‚úèÔ∏è Edit</div>
    <div class="tab" data-tab="tab3">üìä Statistik</div>
    <div class="tab" data-tab="tab4">üì∑ Upload</div>
    <div class="tab" data-tab="tab5">‚¨áÔ∏è Download</div>
  </div>

  <!-- === TAB 1: Form Pendaftaran === -->
  <div id="tab1" class="tab-content active">
    <form id="form">
      <input type="hidden" name="No. Pendaftaran" />

      <h3 class="section-title">üë®‚Äçüéìüë©‚Äçüéì Data Siswa</h3>
      <div class="grid">
        <div><label>Nama</label><input type="text" name="Nama" required /></div>
        <div><label>Jenis Kelamin</label>
          <select name="JK" required>
            <option value="">-- Pilih --</option>
            <option value="L">Laki-laki</option>
            <option value="P">Perempuan</option>
          </select>
        </div>

        <div><label>NISN</label><input type="text" name="NISN" /></div>
        <div><label>Tempat Lahir</label><input type="text" name="Tempat Lahir" /></div>

        <div><label>Tanggal Lahir</label><input type="date" name="Tanggal Lahir" /></div>
        <div><label>NIK</label><input type="text" name="NIK" /></div>

        <div style="grid-column:1/3"><label>Alamat</label><input type="text" name="Alamat" /></div>

        <div><label>RT</label><input type="text" name="RT" /></div>
        <div><label>RW</label><input type="text" name="RW" /></div>

        <div><label>Dusun</label><input type="text" name="Dusun" /></div>
        <div><label>Kelurahan</label><input type="text" name="Kelurahan" /></div>

        <div><label>Kecamatan</label><input type="text" name="Kecamatan" /></div>
        <div><label>Provinsi</label><input type="text" name="Provinsi" /></div>

        <div><label>Kode Pos</label><input type="text" name="Kode Pos" /></div>
        <div><label>HP</label><input type="text" name="HP" /></div>
      </div>

      <h3 class="section-title">üë®‚Äçüë©‚Äçüë¶ Data Orang Tua</h3>
      <div class="grid">
        <div><label>Nama Ayah</label><input type="text" name="Nama Ayah" /></div>
        <div><label>Tahun Lahir Ayah</label><input type="number" name="Tahun Lahir Ayah" /></div>

        <div><label>Jenjang Pendidikan Ayah</label><input type="text" name="Jenjang Pendidikan Ayah" /></div>
        <div><label>Pekerjaan Ayah</label><input type="text" name="Pekerjaan Ayah" /></div>

        <div><label>NIK Ayah</label><input type="text" name="NIK Ayah" /></div>
        <div><label>Nama Ibu</label><input type="text" name="Nama Ibu" /></div>

        <div><label>Tahun Lahir Ibu</label><input type="number" name="Tahun Lahir Ibu" /></div>
        <div><label>Jenjang Pendidikan Ibu</label><input type="text" name="Jenjang Pendidikan Ibu" /></div>

        <div><label>Pekerjaan Ibu</label><input type="text" name="Pekerjaan Ibu" /></div>
        <div><label>NIK Ibu</label><input type="text" name="NIK Ibu" /></div>

        <div>
          <label for="rombel" class="block text-sm font-medium text-gray-700">Rombel</label>
          <select id="rombel" name="Rombel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm 
           focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            <option value="">-- Pilih Rombel --</option>
            <option value="VII">VII</option>
            <option value="VIII">VIII</option>
            <option value="IX">IX</option>
            <option value="X">X</option>
            <option value="XI">XI</option>
            <option value="XII">XII</option>
          </select>
        </div>

      </div>

      <div class="flex flex-wrap gap-3 my-6 mt-8">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
          üöÄ Kirim Data
        </button>
        <button type="button" id="btnReset"
          class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 transition">
          Reset
        </button>
      </div>

    </form>
    <div id="msg" class="small" style="margin-top:8px"></div>
  </div>

  <!-- === TAB 2: Data Siswa === -->
  <div id="tab2" class="tab-content">
    <h3 class="section-title">üìã Data Siswa</h3>

    <!-- Search Box -->
    <div class="flex flex-col sm:flex-row gap-2">
      <input type="text" id="searchInput" placeholder="üîç Cari Nama atau No.Reg" class="w-full sm:w-96 px-4 py-2 border border-gray-300 rounded-lg shadow-sm 
             focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
             transition duration-200" />

      <button id="btnSearch" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md 
             hover:bg-blue-700 hover:scale-105 transition transform w-full sm:w-auto">
        Cari
      </button>
    </div>

    <!-- Search Result -->
    <div id="searchResult" class="mt-4 space-y-3"></div>
  </div>

  <!-- TAB 3: Monitor Data (ringkasan) -->
  <div id="tab3" class="tab-content">
    <h3 class="section-title">üìä Statistik Pendaftar</h3>

    <!-- Cards -->
    <div class="grid sm:grid-cols-3 gap-4" id="statsCards">
      <div class="card card-total">
        <p class="text-sm">Total Pendaftar</p>
        <p id="stat-total" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-total-pct" class="text-xs mt-1"></p>
      </div>
      <div class="card card-gender">
        <p class="text-sm">Laki-laki</p>
        <p id="stat-male" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-male-pct" class="text-xs mt-1"></p>
      </div>
      <div class="card card-gender" style="border-left-color:#f06292;">
        <p class="text-sm">Perempuan</p>
        <p id="stat-female" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-female-pct" class="text-xs mt-1"></p>
      </div>
    </div>

    <!-- Rombel Cards -->
    <div class="grid sm:grid-cols-3 gap-4 mt-4" id="rombelCards">
      <div class="card card-rombel">
        <p class="text-sm">Rombel VII</p>
        <p id="stat-vii" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-vii-pct" class="text-xs mt-1"></p>
      </div>
      <div class="card card-rombel">
        <p class="text-sm">Rombel VIII</p>
        <p id="stat-viii" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-viii-pct" class="text-xs mt-1"></p>
      </div>
      <div class="card card-rombel">
        <p class="text-sm">Rombel IX</p>
        <p id="stat-ix" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-ix-pct" class="text-xs mt-1"></p>
      </div>
      <div class="card card-rombel">
        <p class="text-sm">Rombel X</p>
        <p id="stat-x" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-x-pct" class="text-xs mt-1"></p>
      </div>
      <div class="card card-rombel">
        <p class="text-sm">Rombel XI</p>
        <p id="stat-xi" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-xi-pct" class="text-xs mt-1"></p>
      </div>
      <div class="card card-rombel">
        <p class="text-sm">Rombel XII</p>
        <p id="stat-xii" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-xii-pct" class="text-xs mt-1"></p>
      </div>
      <div class="card card-other">
        <p class="text-sm">Rombel Lainnya</p>
        <p id="stat-lainnya" class="text-2xl font-bold">‚Äî</p>
        <p id="stat-lainnya-pct" class="text-xs mt-1"></p>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid sm:grid-cols-2 gap-4 mt-6">
      <div class="card" id="chart-gender" style="height:300px;"></div>
      <div class="card" id="chart-rombel" style="height:300px;"></div>
    </div>

    <!-- Buttons -->
    <div class="mt-4 flex gap-2">
      <button id="btnRefreshStats"
        class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition">
        üîÑ Refresh Statistik
      </button>
      <button id="btnComputeCompleteness"
        class="bg-yellow-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-yellow-600 transition">
        üìä Cek Kelengkapan (Next)
      </button>
    </div>

    <div id="stats-note" class="text-sm text-gray-500 mt-3"></div>
  </div>

  <!-- === TAB 4: Upload Foto === -->
  <div id="tab4" class="tab-content">
    <h3 class="section-title">üì∑ Upload Foto Siswa</h3>
    <label for="studentSelect" class="block text-sm font-medium text-gray-700 mb-1 mt-2">Pilih Siswa (Belum Ada
      Foto):</label>
    <select id="studentSelect" required class="w-full sm:w-96 px-4 py-2 border border-gray-300 rounded-lg shadow-sm 
     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
     transition duration-200 mb-4">
      <option value="" disabled selected>... Memuat Daftar Siswa ...</option>
    </select>
    <input type="file" id="fotoInput" accept="image/*" class="w-full sm:w-96 px-4 py-2 border border-gray-300 rounded-lg shadow-sm 
       focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
       transition duration-200" />
    <button id="btnUpload" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md 
       hover:bg-blue-700 hover:scale-105 transition transform w-full sm:w-auto mt-2">Upload</button>
    <div id="uploadMsg" class="mt-2 text-sm text-red-500"></div>
  </div>

  <!-- === Modal Preview Modern === -->
  <div id="previewModal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div
      class="bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-lg transform scale-95 opacity-0 transition-all duration-300"
      id="modalBox">
      <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Konfirmasi Data</h2>
      <div id="previewContent" class="space-y-2 text-gray-700 text-sm max-h-64 overflow-y-auto pr-2"></div>
      <div class="mt-6 flex justify-end gap-3">
        <button id="btnCancel"
          class="px-4 py-2 rounded-xl bg-gray-200 text-gray-700 hover:bg-gray-300 transition">Batal</button>
        <button id="btnConfirm" class="px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600 transition">Kirim
          ‚úÖ</button>
      </div>
    </div>
  </div>

  <!-- === TAB 5: Download Data === -->
  <div id="tab5" class="tab-content"
    style="padding: 20px; max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif;">
    <h3 class="section-title" style="font-size: 1.5rem; margin-bottom: 10px; color: #1a73e8;">‚¨áÔ∏è Download Data</h3>
    <p style="font-size: 1rem; margin-bottom: 20px; color: #333;">Download seluruh data pendaftaran dalam format Excel:
    </p>

    <a id="btnDownload" href="#" target="_top" style="
       display: inline-block;
       padding: 12px 25px;
       background-color: #1a73e8;
       color: #fff;
       text-decoration: none;
       font-weight: bold;
       border-radius: 6px;
       transition: background-color 0.3s, transform 0.2s;
     " onmouseover="this.style.backgroundColor='#1669c1'; this.style.transform='scale(1.05)';"
      onmouseout="this.style.backgroundColor='#1a73e8'; this.style.transform='scale(1)';">
      üì• Download Data (Excel)
    </a>
  </div>
  </div>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxp6qxgxIPKScMEGZ-hs2_wlqFfZW3tS5y4qMEIHDv2cf533KFhRQ9-tVf6b_beVgRr/exec";

    const form = document.getElementById('form');
    const msg = document.getElementById('msg');
    const preview = document.getElementById('preview');

    function showMsg(t, clr = '') {
      msg.textContent = t;
      msg.style.color = clr;
      setTimeout(() => { msg.textContent = ''; }, 5000);
    }

    // === Submit Form (show modal) ===
    form.addEventListener("submit", e => {
      e.preventDefault();
      const fd = new FormData(form);

      // Buat konten preview
      let html = "";
      fd.forEach((val, key) => {
        html += `<p><span class="font-semibold">${key}:</span> ${val}</p>`;
      });
      document.getElementById("previewContent").innerHTML = html;

      // Simpan sementara
      window.pendingFormData = fd;

      // Show modal dengan animasi
      const modal = document.getElementById("previewModal");
      const box = document.getElementById("modalBox");
      modal.classList.remove("hidden");
      setTimeout(() => {
        box.classList.remove("opacity-0", "scale-95");
        box.classList.add("opacity-100", "scale-100");
      }, 20);
    });

    // === Cancel (close modal) ===
    document.getElementById("btnCancel").addEventListener("click", () => {
      closeModal();
    });

    function closeModal() {
      const box = document.getElementById("modalBox");
      box.classList.remove("opacity-100", "scale-100");
      box.classList.add("opacity-0", "scale-95");
      setTimeout(() => {
        document.getElementById("previewModal").classList.add("hidden");
      }, 300);
    }

    // === Confirm API EC2 AWS ===
    document.getElementById("btnConfirm").addEventListener("click", () => {
      if (!window.pendingFormData) return;

      // Konversi FormData ke JSON biar dimengerti sama API Node.js ente
      const data = {};
      window.pendingFormData.forEach((value, key) => {
        // Map nama field dari form (Bahasa Indonesia) ke kolom database (snake_case/kecil)
        const keyMap = {
          "Nama": "nama",
          "JK": "jk",
          "NISN": "nisn",
          "Tempat Lahir": "tempat_lahir",
          "Tanggal Lahir": "tanggal_lahir",
          "NIK": "nik",
          "Alamat": "alamat",
          "RT": "rt",
          "RW": "rw",
          "Dusun": "dusun",
          "Kelurahan": "kelurahan",
          "Kecamatan": "kecamatan",
          "Provinsi": "provinsi",
          "Kode Pos": "kode_pos",
          "HP": "hp",
          "Nama Ayah": "nama_ayah",
          "Tahun Lahir Ayah": "tahun_lahir_ayah",
          "Jenjang Pendidikan Ayah": "pendidikan_ayah",
          "Pekerjaan Ayah": "pekerjaan_ayah",
          "NIK Ayah": "nik_ayah",
          "Nama Ibu": "nama_ibu",
          "Tahun Lahir Ibu": "tahun_lahir_ibu",
          "Jenjang Pendidikan Ibu": "pendidikan_ibu",
          "Pekerjaan Ibu": "pekerjaan_ibu",
          "NIK Ibu": "nik_ibu",
          "Rombel": "rombel"
        };
        data[keyMap[key] || key] = value;
      });

      // Tembak ke API baru ente di EC2
      fetch("http://halifa.ciwai.dev:3000/daftar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(d => {
          closeModal();
          if (d.success) {
            alert("‚úÖ Alhamdulillah! Data berhasil masuk RDS. ID: " + d.id);
            form.reset();
          } else {
            alert("‚ùå Gagal simpan ke RDS: " + d.error);
          }
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Waduh, koneksi ke API halifa.ciwai.dev putus bro!");
        });
    });

    // === Statistik ===
    google.charts.load('current', { packages: ['corechart'] });

    // helper: cari nilai field pertama dari list kandidat
    function pickFieldValue(row, candidates) {
      for (const k of candidates) {
        if (k in row && row[k] != null) return String(row[k]);
      }
      return undefined;
    }

    function normalizeGender(raw) {
      if (!raw) return 'unknown';
      const v = String(raw).trim().toLowerCase();
      if (['l', 'laki-laki', 'laki', 'male', 'm'].includes(v)) return 'male';
      if (['p', 'perempuan', 'perempuan', 'female', 'f'].includes(v)) return 'female';
      return 'unknown';
    }

    function detectLevel(raw) {
      if (!raw) return 'Unknown';
      raw = raw.toUpperCase();

      if (raw.includes('VII')) return 'VII';
      if (raw.includes('VIII')) return 'VIII';
      if (raw.includes('IX')) return 'IX';
      if (raw.includes('XII')) return 'XII';
      if (raw.includes('XI')) return 'XI';
      if (raw.includes('X ')) return 'X';

      return 'Unknown';
    }

    function setStat(idNum, idPct, value, totalForPct) {
      const elNum = document.getElementById(idNum);
      const elPct = document.getElementById(idPct);
      elNum.textContent = String(value || 0);
      if (totalForPct && totalForPct > 0) {
        elPct.textContent = `(${Math.round((value / totalForPct) * 100)}%)`;
      } else {
        elPct.textContent = '';
      }
    }

    async function refreshStats() {
      const noteEl = document.getElementById('stats-note');
      noteEl.textContent = 'Memuat data...';

      try {
        const res = await fetch(SCRIPT_URL + '?action=read');
        let rows = await res.json();

        // ===  DATA ARRAY ===
        if (!Array.isArray(rows)) {
          console.error("Data dari server bukan array:", rows);
          noteEl.textContent = 'Gagal memuat data. Format data dari server salah.';
          return;
        }
        // ===============================================
        const total = Array.isArray(rows) ? rows.length : 0;

        const genderCandidates = ['JK', 'Jenis Kelamin', 'Gender', 'Sex'];
        const levelCandidates = ['Program/Layanan', 'Rombel Saat Ini', 'Jenjang', 'Level', 'Tingkat', 'Bentuk Pendidikan'];
        const rombels = ["Kelas VII", "Kelas VIII", "Kelas IX", "Kelas X", "Kelas XI", "Kelas XII"];
        const rombelKeys = ["VII", "VIII", "IX", "X", "XI", "XII"];

        let male = 0, female = 0, unknownGender = 0;
        let rombelCount = {};
        rombels.forEach(r => rombelCount[r] = 0);
        rombelCount["Lainnya"] = 0;

        rows.forEach(r => {
          const gRaw = pickFieldValue(r, genderCandidates);
          const g = normalizeGender(gRaw);
          if (g === 'male') male++;
          else if (g === 'female') female++;
          else unknownGender++;

          const lvlRaw = pickFieldValue(r, levelCandidates) || "";
          const rombel = lvlRaw.trim();
          if (rombels.includes(rombel)) rombelCount[rombel]++;
          else rombelCount["Lainnya"]++;
        });

        // Total Rombel untuk persentase
        const totalRombelAll = rombelKeys.reduce((acc, k) => acc + rombelCount[`Kelas ${k}`], 0) + rombelCount["Lainnya"];

        // Update angka
        setStat('stat-total', 'stat-total-pct', total);
        setStat('stat-male', 'stat-male-pct', male);
        setStat('stat-female', 'stat-female-pct', female);

        rombelKeys.forEach(k => {
          setStat(`stat-${k.toLowerCase()}`, `stat-${k.toLowerCase()}-pct`, rombelCount[`Kelas ${k}`], totalRombelAll);
        });

        setStat('stat-lainnya', 'stat-lainnya-pct', rombelCount["Lainnya"], totalRombelAll);

        // Charts
        drawGenderChart(male, female);
        drawRombelChart(rombelCount);

        noteEl.textContent = `Data terakhir: ${total} row. ${unknownGender ? unknownGender + " gender tidak terdeteksi." : ""}`;

      } catch (err) {
        console.error('refreshStats error', err);
        noteEl.textContent = 'Gagal memuat data. Cek koneksi atau SCRIPT_URL.';
      }
    }

    function drawGenderChart(male, female) {
      const data = google.visualization.arrayToDataTable([
        ['Gender', 'Jumlah'],
        ['Laki-laki', male],
        ['Perempuan', female]
      ]);
      const chart = new google.visualization.PieChart(document.getElementById('chart-gender'));
      chart.draw(data, { pieHole: 0.4, legend: { position: 'bottom' } });
    }

    function drawRombelChart(rombels) {
      const dataArr = [['Rombel', 'Jumlah']];
      Object.keys(rombels).forEach(k => dataArr.push([k, rombels[k]]));
      const data = google.visualization.arrayToDataTable(dataArr);
      const chart = new google.visualization.ColumnChart(document.getElementById('chart-rombel'));
      chart.draw(data, { legend: { position: 'none' }, chartArea: { width: '80%', height: '70%' } });
    }


    // event listeners
    document.getElementById('btnRefreshStats').addEventListener('click', refreshStats);

    // opsional: tombol lanjutan cek kelengkapan nanti (step 2)
    document.getElementById('btnComputeCompleteness').addEventListener('click', () => {
      alert('Nanti kita hitung kelengkapan field & tampilkan progress.');
    });

    // auto-refresh pertama kali
    refreshStats();

    // === Edit Data ===
    function editData(noPend) {
      fetch(SCRIPT_URL + "?action=read")
        .then(res => res.json())
        .then(rows => {
          const d = rows.find(r => r["No. Pendaftaran"] === noPend);
          if (!d) { alert("‚ùå Data tidak ditemukan"); return; }
          for (const k in d) {
            const input = form.querySelector(`[name="${k}"]`);
            if (input) input.value = d[k];
          }
          // auto switch tab ke form
          switchTab("tab1");
        });
    }

    // === Search ===
    document.getElementById('btnSearch').addEventListener('click', () => {
      const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
      fetch(SCRIPT_URL + "?action=read")
        .then(res => res.json())
        .then(rows => {
          const result = rows.filter(r =>
            String(r["Nama"]).toLowerCase().includes(keyword) ||
            String(r["NISN"]).toLowerCase().includes(keyword)
          );
          const out = document.getElementById("searchResult");
          out.innerHTML = result.map(d => `
        <div class="preview-card">
          <p><b>No. Pendaftaran:</b> ${d["No. Pendaftaran"]}</p>
          <p><b>Nama:</b> ${d["Nama"]}</p>
          <p><b>NISN:</b> ${d["NISN"]}</p>
          <div class="mt-2 flex gap-2">
            <button onclick="viewDetail('${d["No. Pendaftaran"]}')">üëÅÔ∏è View</button>
            <button onclick="editData('${d["No. Pendaftaran"]}')">‚úèÔ∏è Edit</button>
          </div>
          <div id="detail-${d["No. Pendaftaran"]}" class="hidden mt-2 p-2 border rounded bg-gray-50"></div>
        </div>`).join("");
        });
    });

    // Fungsi View Detail
    function viewDetail(noPend) {
      // === UBAH STRATEGI: FETCH HANYA SATU DATA DARI SERVER ===
      fetch(`${SCRIPT_URL}?action=read_detail&noPend=${noPend}`) // Kirim ID yang mau dicari ke server
        .then(res => {
          // Pastikan response HTTP sukses
          if (!res.ok) throw new Error('Gagal fetch data detail dari server.');
          return res.json();
        })
        .then(d => {
          // 'd' di sini HANYA berisi SATU objek data siswa, bukan array of rows.
          if (!d || d.error) {
            alert("‚ùå Data tidak ditemukan atau ada error: " + (d.error || 'Unknown Error'));
            return;
          }

          const container = document.getElementById(`detail-${noPend}`);
          // Karena 'd' sudah berupa objek detail tunggal, lo bisa langsung pakai!

          const fields = [
            ["JK", "Jenis Kelamin"],
            ["Tempat Lahir", "Tempat Lahir"],
            ["Tanggal Lahir", "Tanggal Lahir"],
            ["NIK", "NIK"],
            ["Alamat", "Alamat"],
            ["RT", "RT"],
            ["RW", "RW"],
            ["Dusun", "Dusun"],
            ["Kelurahan", "Kelurahan"],
            ["Kecamatan", "Kecamatan"],
            ["Kode Pos", "Kode Pos"],
            ["HP", "HP"],
            ["Nama Ayah", "üë® Nama Ayah"],
            ["Tahun Lahir Ayah", "Tahun Lahir Ayah"],
            ["Jenjang Pendidikan Ayah", "Jenjang Pendidikan Ayah"],
            ["Pekerjaan Ayah", "Pekerjaan Ayah"],
            ["NIK Ayah", "NIK Ayah"],
            ["Nama Ibu", "üë© Nama Ibu"],
            ["Tahun Lahir Ibu", "Tahun Lahir Ibu"],
            ["Jenjang Pendidikan Ibu", "Jenjang Pendidikan Ibu"],
            ["Pekerjaan Ibu", "Pekerjaan Ibu"],
            ["NIK Ibu", "NIK Ibu"],
            ["Rombel Saat Ini", "üìö Rombel Saat Ini"],
          ];

          let filled = [];
          let empty = [];

          fields.forEach(([key, label]) => {
            // Gunakan d[key] langsung karena sudah objek
            if (d[key] && d[key].toString().trim() !== "") {
              filled.push(`<p><b>${label}:</b> ${d[key]}</p>`);
            } else {
              empty.push(label); // simpan label kosong
            }
          });

          // Logika tampilan lo (sudah keren, tidak perlu diubah)
          container.innerHTML = `
                ${filled.join("")}
                ${empty.length > 0
              ? `
                        <div class="mt-3 p-3 border border-yellow-300 rounded bg-yellow-50">
                            <p class="font-semibold text-yellow-700">‚ö†Ô∏è Data berikut belum diisi:</p>
                            <ul class="list-disc list-inside text-yellow-700">
                                ${empty.map(f => `<li>${f}</li>`).join("")}
                            </ul>
                        </div>
                    `
              : ""
            }
            `;

          container.classList.toggle("hidden");
        })
        .catch(err => {
          console.error("Fetch Error:", err);
          alert("Terjadi kesalahan jaringan saat memuat detail.");
        });
    }

    // === Tabs Switching ===
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    function switchTab(id) {
      tabs.forEach(t => t.classList.remove("active"));
      contents.forEach(c => c.classList.remove("active"));
      document.querySelector(`.tab[data-tab="${id}"]`).classList.add("active");
      document.getElementById(id).classList.add("active");
    }
    tabs.forEach(t => t.addEventListener("click", () => switchTab(t.dataset.tab)));

    // auto-load preview
    // loadPreview();
  </script>

  <script>
    // --- Konstanta Ukuran 3x4 (Wajib di awal script) ---
    const MAX_WIDTH_3X4 = 600;
    const MAX_HEIGHT_3X4 = 800;
    const QUALITY = 0.8;
    let resizedDataToSend = null; // Variable global untuk menyimpan data hasil resize
    // ----------------------------------------------------


    // Ambil elemen (TAMBAH nisnInput)
    const nisnInput = document.getElementById("nisnInput");
    const fotoInput = document.getElementById("fotoInput");
    const btnUpload = document.getElementById("btnUpload");
    const previewModal = document.getElementById("previewModal");
    const previewContent = document.getElementById("previewContent");
    const btnCancel = document.getElementById("btnCancel");
    const btnConfirm = document.getElementById("btnConfirm");
    const uploadMsg = document.getElementById("uploadMsg");
    const modalBox = document.getElementById("modalBox");

    // Ambil elemen baru
    const studentSelect = document.getElementById("studentSelect");

    // --- FUNGSI BARU: Isi Dropdown ---
    function populateStudentDropdown(students) {
      if (students.length === 0) {
        studentSelect.innerHTML = '<option value="" disabled selected>SEMUA SISWA SUDAH PUNYA FOTO! ‚úÖ</option>';
        uploadMsg.textContent = "Semua siswa di database sudah memiliki foto. Tidak ada yang perlu di-upload.";
        btnUpload.disabled = true; // Non-aktifkan tombol upload
        return;
      }

      // Isi Dropdown
      let options = '<option value="" disabled selected>--- Pilih Nama Siswa ---</option>';
      students.forEach(student => {
        options += `<option value="${student.nisn}">${student.nama} (${student.nisn})</option>`;
      });
      studentSelect.innerHTML = options;
      uploadMsg.textContent = "";
      btnUpload.disabled = false;
    }

    // --- FUNGSI BARU: Handle Error GAS ---
    function showError(error) {
      uploadMsg.textContent = `ERROR dari GAS: ${error.message}`;
      studentSelect.innerHTML = '<option value="" disabled selected>Gagal memuat daftar siswa. Cek Code.gs.</option>';
    }

    // --- FUNGSI BARU: Load Daftar Siswa ---
    function loadStudentList() {
      studentSelect.innerHTML = '<option value="" disabled selected>... Sedang Memuat Daftar Siswa ...</option>';

      // Panggil fungsi GAS untuk ambil daftar yang belum ada foto
      google.script.run
        .withSuccessHandler(populateStudentDropdown)
        .withFailureHandler(showError)
        .getStudentsWithoutPhoto();
    }

    // --- FUNGSI RESIZING (3X4) ---
    /**
     * Fungsi untuk resize foto ke ukuran maksimal 600x800px (rasio 3:4)
     * (PASTIKAN FUNGSI INI SUDAH ADA DI SCRIPT BRO)
     */
    function resizeImage(fileObj) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            let width = img.width;
            let height = img.height;

            const widthRatio = MAX_WIDTH_3X4 / width;
            const heightRatio = MAX_HEIGHT_3X4 / height;
            let ratio = (widthRatio < heightRatio) ? widthRatio : heightRatio;

            if (ratio > 1) { // Jika foto sudah kecil, pakai yang asli
              resolve(e.target.result);
              return;
            }

            width = width * ratio;
            height = height * ratio;

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            ctx.drawImage(img, 0, 0, width, height);

            const resizedDataUrl = canvas.toDataURL('image/jpeg', QUALITY);
            resolve(resizedDataUrl);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(fileObj);
      });
    }
    // -----------------------------

    // Klik Upload ‚Üí Preview (SEKARANG SUDAH ADA VALIDASI NISN DAN RESIZING)
    btnUpload.addEventListener("click", () => {
      // Ambil NISN dari selected value di dropdown
      const nisn = studentSelect.value;
      const file = fotoInput.files[0];

      // 1. Validasi NISN dan File
      if (!nisn) {
        uploadMsg.textContent = "Pilih Nama Siswa dari Daftar!";
        return;
      }
      if (!file) {
        uploadMsg.textContent = "Pilih foto dulu üòÖ";
        return;
      }
      uploadMsg.textContent = "Memproses foto & resize ke 3x4... Mohon tunggu.";

      // 2. Lakukan Resizing (Asynchronous: pakai .then())
      resizeImage(file)
        .then(resizedDataUrl => {
          // Data sudah di-resize! Kita simpan dulu.
          const parts = resizedDataUrl.split(',');
          const fileData = parts[1];
          const mimeType = parts[0].match(/:(.*?);/)[1];

          resizedDataToSend = {
            nisn: nisn,
            fileName: file.name,
            mimeType: mimeType,
            fileData: fileData
          };

          // 3. Tampilkan Modal Preview
          previewContent.innerHTML = `
                <p><strong>NISN Siswa:</strong> ${nisn}</p>
                <p><strong>Nama File:</strong> ${file.name} (Akan disimpan di Drive dengan nama: ${nisn}_FOTO.${mimeType.split('/').pop()})</p>
                <p class="text-xs text-green-600 font-semibold">Foto sudah di-resize ke maks. 600x800px (3x4).</p>
                <img src="${resizedDataUrl}" alt="Preview Foto" class="w-full rounded-lg mt-2 border"/>
            `;
          uploadMsg.textContent = "";
          previewModal.classList.remove("hidden");
          setTimeout(() => modalBox.classList.remove("opacity-0", "scale-95"), 10);
        })
        .catch(err => {
          uploadMsg.textContent = "Gagal memproses foto. Coba ganti file. üò¢";
          console.error(err);
          resizedDataToSend = null;
        });
    });

    // Klik Batal ‚Üí Tutup modal
    btnCancel.addEventListener("click", () => {
      modalBox.classList.add("opacity-0", "scale-95");
      setTimeout(() => previewModal.classList.add("hidden"), 200);
      resizedDataToSend = null; // Reset data
    });

    // Klik Konfirmasi ‚Üí Upload (MENGGANTI LOGIKA FETCH DENGAN google.script.run)
    btnConfirm.addEventListener("click", () => {
      if (!resizedDataToSend) return;

      // Tampilkan loading dan tutup modal
      uploadMsg.textContent = "Mengirim data... Mohon tunggu.";
      modalBox.classList.add("opacity-0", "scale-95");
      setTimeout(() => previewModal.classList.add("hidden"), 200);

      // 1. Panggil fungsi uploadFile di Code.gs
      google.script.run
        .withSuccessHandler(result => {
          // Berhasil dari Code.gs
          uploadMsg.textContent = result;
          // Reset semua input dan variabel
          fotoInput.value = "";
          nisnInput.value = "";
          resizedDataToSend = null;
        })
        .withFailureHandler(error => {
          // Gagal dari Code.gs
          uploadMsg.textContent = `Upload Gagal: ${error.message}`;
          resizedDataToSend = null;
        })
        .uploadFile(resizedDataToSend); // Mengirim data yang sudah di-resize

      // === Fungsi Cari Data ===
      document.getElementById("btnSearch").addEventListener("click", () => {
        const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
        if (!keyword) {
          alert("Masukkan kata kunci dulu!");
          return;
        }

        fetch(SCRIPT_URL + "?action=read")
          .then(res => res.json())
          .then(data => {
            const results = data.filter(d =>
              String(d["Nama"]).toLowerCase().includes(keyword) ||
              String(d["NISN"]).toLowerCase().includes(keyword)
            );

            const resultDiv = document.getElementById("searchResult");
            if (results.length === 0) {
              resultDiv.innerHTML = "<p>‚ùå Tidak ada hasil</p>";
              return;
            }

            resultDiv.innerHTML = results.map(d => `
        <div class="result-card">
          <p><b>${d["No. Pendaftaran"]}</b> - ${d["Nama"]} (NISN: ${d["NISN"]})</p>
          <button onclick="editData('${d["No. Pendaftaran"]}')">‚úèÔ∏è Edit</button>
        </div>
      `).join("");
          })
          .catch(err => console.error("‚ùå Gagal cari data:", err));
      });
    });

    // --- Script untuk Tab 5 (Download) ---

    // [2] Setup Download Button Handler (Jurus Bypass URL)
    const btnDownload = document.getElementById('btnDownload');

    if (btnDownload && typeof SCRIPT_URL !== 'undefined') {

      // Tambahkan listener untuk menangani klik
      btnDownload.addEventListener('click', async (event) => {
        event.preventDefault(); // Hentikan aksi link default

        btnDownload.textContent = "‚åõ Mempersiapkan Download...";
        btnDownload.disabled = true;

        try {
          // Panggil action=download di GAS. GAS sekarang hanya mengembalikan JSON URL.
          const res = await fetch(SCRIPT_URL + '?action=download');
          const data = await res.json();

          if (data.url) {
            // Jika URL diterima, buka di tab baru.
            // Ini akan melewati blokir keamanan iFrame Web App.
            window.open(data.url, '_blank');
          } else if (data.error) {
            console.error("Download Error:", data.error);
            alert('Gagal mendownload data. Error Server: ' + data.error);
          }
        } catch (err) {
          console.error('Fetch Download Error:', err);
          alert('Gagal mengambil URL download. Cek koneksi.');
        } finally {
          btnDownload.textContent = "üì• Download Data (Excel)";
          btnDownload.disabled = false;
        }
      });
    }

    loadStudentList();

  </script>

  <!-- Back to Top Button -->
  <button onclick="scrollToTop()" id="backToTopBtn" class="hidden fixed bottom-6 right-6 z-50 
  w-12 h-12 flex items-center justify-center
  bg-white/40 hover:bg-white/60 backdrop-blur-sm
  text-blue-800 hover:text-blue-900 
  rounded-full shadow-md transition duration-300 border border-white/50">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd"
        d="M10 4a1 1 0 01.894.553l5 10a1 1 0 01-1.788.894L10 6.618 5.894 15.447a1 1 0 01-1.788-.894l5-10A1 1 0 0110 4z"
        clip-rule="evenodd" />
    </svg>
  </button>

  <!-- AOS Script -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- Script Section -->
  <script>
    // ‚úÖ Init AOS (Animate On Scroll)
    AOS.init({
      duration: 800,
      once: true,
    });

    // ‚úÖ Scroll-to-top button logic
    const backToTopBtn = document.getElementById("backToTopBtn");

    window.addEventListener("scroll", () => {
      if (window.scrollY > 300) {
        backToTopBtn.classList.remove("hidden");
      } else {
        backToTopBtn.classList.add("hidden");
      }
    });

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>

</html>